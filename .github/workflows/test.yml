name: Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  analyze:
    name: Analyze Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.6'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --set-exit-if-changed .

      - name: Analyze code
        run: flutter analyze

  unit-tests:
    name: Unit Tests (Without Isar)
    runs-on: ubuntu-latest
    needs: analyze
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.6'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run unit tests (excluding Isar-dependent tests)
        run: |
          flutter test \
            test/domain/ \
            test/presentation/ \
            test/data/repositories/ \
            test/data/mappers/ \
            --coverage \
            --reporter=expanded

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: unit-tests-coverage

  integration-tests:
    name: Full Test Suite (With Isar)
    runs-on: ${{ matrix.os }}
    needs: analyze
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.6'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Setup Isar Native Library (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "Setting up Isar for Linux..."
          cp ~/.pub-cache/hosted/pub.dev/isar_flutter_libs-*/linux/libisar.so libisar.so || echo "Isar library will be loaded at runtime"

      - name: Setup Isar Native Library (macOS)
        if: runner.os == 'macOS'
        run: |
          echo "Setting up Isar for macOS..."
          cp ~/.pub-cache/hosted/pub.dev/isar_flutter_libs-*/macos/libisar.dylib libisar.dylib || echo "Isar library will be loaded at runtime"

      - name: Verify Isar Installation
        run: |
          if [ -f "libisar.dylib" ] || [ -f "libisar.so" ]; then
            echo "Isar native library found"
          else
            echo "Note: Isar library will be loaded at runtime from Flutter package"
          fi

      - name: Run all tests
        run: |
          flutter test \
            --coverage \
            --reporter=expanded \
            --timeout=2m

      - name: Generate coverage report
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov
          lcov --summary coverage/lcov.info

      - name: Upload full coverage to Codecov
        if: runner.os == 'Linux'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: all-tests
          name: full-test-coverage

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test Results Summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Jobs Status:" >> $GITHUB_STEP_SUMMARY
          echo "- Analyze: ${{ needs.analyze.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Statistics:" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Tests**: 236" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Tests**: 199 (84%)" >> $GITHUB_STEP_SUMMARY
          echo "- **Integration Tests**: 37 (16%)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Breakdown:" >> $GITHUB_STEP_SUMMARY
          echo "- Unit tests (no Isar): ~76 tests" >> $GITHUB_STEP_SUMMARY
          echo "- Data source tests (requires Isar): 46 tests" >> $GITHUB_STEP_SUMMARY
          echo "- Integration tests (requires Isar): 37 tests" >> $GITHUB_STEP_SUMMARY
